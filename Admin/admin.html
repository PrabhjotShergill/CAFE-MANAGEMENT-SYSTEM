<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cafe QuickBite - Admin Dashboard</title>
  <style>
    body {
     background: #f7f7f7; 
     font-family: 'Segoe UI', Arial, sans-serif; 
     margin: 0; 
     padding: 0; 
     }
    .admin-header {
     padding: 18px 40px; 
     background: #fff; 
     font-weight: bold;
      font-size: 2rem; 
      border-bottom: 1px solid #e9e9e9;
       display:flex; 
       justify-content: space-between; 
       align-items:center; }
    .admin-header .highlight { 
    color: #8bc34a; 
    }
    .dashboard-container { max-width:1000px; margin:40px auto; background:#fff; border-radius:16px; padding:30px 28px; box-shadow:0 1px 16px rgba(80,80,80,0.07); }
    h2 { margin-bottom:20px; font-weight:600; color:#333; }
    .section { margin-bottom:38px; }
    table { width:100%; border-collapse:collapse; font-size:1rem; }
    table, th, td { border:1px solid #ddd; }
    th, td { padding:10px 12px; text-align:left; }
    th { background:#f3fbe7; color:#79a144; }
    button { background:#8bc34a; border:none; color:white; padding:9px 16px; font-weight:600; cursor:pointer; border-radius:7px; margin-top:12px; transition:background .2s ease; }
    button:hover { background:#689f38; }
    input[type="text"], select { padding:7px 12px; font-size:1rem; border-radius:6px; border:1px solid #ccc; font-weight:600; color:#3b3b3b; width:220px; }
    input[type="text"]:focus, select:focus { border-color:#8bc34a; outline:none; }
    .form-inline { display:flex; gap:15px; flex-wrap:wrap; align-items:center; margin-bottom:15px; }
    .btn-small { padding:7px 14px; font-size:.95rem; }
    .danger { background:#c62828; }
  </style>
</head>
<body>
  <header class="admin-header">
    Cafe QuickBite <span class="highlight">Admin</span> Dashboard
  </header>

  <div class="dashboard-container">
    <!-- STAFF MANAGEMENT -->
    <div class="section" id="staffManagement">
      <h2>Manage Staff</h2>
      <form id="addStaffForm" class="form-inline" onsubmit="return addStaff(event)">
        <input type="text" id="staffName" placeholder="Staff Name" required />
        <select id="staffRole" required>
          <option value="" disabled selected>Select Role</option>
          <option value="Cashier">Cashier</option>
          <option value="Kitchen">Kitchen</option>
          <option value="Waiter">Waiter</option>
          <option value="Inventory">Inventory</option>
          <option value="Manager">Manager</option>
          <option value="Admin">Admin</option>
        </select>
        <button type="submit" class="btn-small">Add Staff</button>
      </form>

      <table id="staffTable">
        <thead>
          <tr><th>Name</th><th>Role</th><th>Change Role</th><th>Remove</th></tr>
        </thead>
        <tbody>
          <!-- Staff data will be injected here -->
        </tbody>
      </table>
    </div>

    <!-- REPORTS -->
    <div class="section" id="reportsSection">
      <h2>Reports</h2>
      <p><strong>Sales Summary:</strong> â‚¹<span id="salesTotal">0</span></p>
      <p><strong>Orders Processed:</strong> <span id="ordersCount">0</span></p>
      <p><strong>Last Updated:</strong> <span id="reportTime">-</span></p>
      <button onclick="generateReport()">Generate New Report</button>
      <p id="reportMsg" style="margin-top:10px; color:green;"></p>
    </div>
  </div>

  <script>
    const staffApi = 'http://localhost:3000/staff';
    const reportApi = 'http://localhost:3000/reports/1';
    const roles = ['Cashier', 'Kitchen', 'Waiter', 'Inventory', 'Manager', 'Admin'];
    let staff = [];

    // Utility: safe JSON stringify for embedding names in onclick handlers
    function jsString(s) { return JSON.stringify(String(s)); }

    // Fetch staff
    async function fetchStaff() {
      try {
        const res = await fetch(staffApi);
        if (!res.ok) throw new Error('Failed to fetch staff: ' + res.status);
        staff = await res.json();
        renderStaff();
      } catch (err) {
        console.error(err);
        alert('Unable to load staff. See console for details.');
      }
    }

    // Render staff table
    function renderStaff() {
      const tbody = document.querySelector('#staffTable tbody');
      tbody.innerHTML = '';
      staff.forEach(s => {
        const tr = document.createElement('tr');

        // create remove button as element to be safe (no innerHTML quoting issues)
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button'; // IMPORTANT: prevents accidental form submit
        removeBtn.className = 'danger';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => removeStaff(s.id, s.name);

        // role select
        const sel = document.createElement('select');
        sel.innerHTML = roles.map(r => `<option value="${r}" ${r === s.role ? 'selected' : ''}>${r}</option>`).join('');
        sel.onchange = () => changeRole(s.id, sel.value);

        tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.role)}</td><td></td><td></td>`;
        tr.children[2].appendChild(sel);
        tr.children[3].appendChild(removeBtn);

        tbody.appendChild(tr);
      });
    }

    // Escape helper to avoid XSS from server data
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Add staff
    async function addStaff(event) {
      event.preventDefault();
      const name = document.getElementById('staffName').value.trim();
      const role = document.getElementById('staffRole').value;
      if (!name || !role) return;

      try {
        const res = await fetch(staffApi, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, role })
        });
        if (!res.ok) throw new Error('Add failed: ' + res.status);
        document.getElementById('addStaffForm').reset();
        await fetchStaff();
      } catch (err) {
        console.error(err);
        alert('Failed to add staff. See console.');
      }
    }

    // Change role
    async function changeRole(id, newRole) {
      try {
        const res = await fetch(`${staffApi}/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole })
        });
        if (!res.ok) throw new Error('Update failed: ' + res.status);
        // update local copy for snappier UI
        const idx = staff.findIndex(x => x.id === id);
        if (idx >= 0) staff[idx].role = newRole;
        renderStaff();
      } catch (err) {
        console.error(err);
        alert('Failed to update role.');
      }
    }

    // Remove staff (fixed)
    async function removeStaff(id, name) {
      if (!confirm(`Remove staff ${name}?`)) return;

      try {
        // disable UI (optional) - find the button and disable it (visual feedback)
        // perform delete
        const res = await fetch(`${staffApi}/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed: ' + res.status);

        // remove from local array and re-render (fast and avoids extra GET)
        staff = staff.filter(s => s.id !== id);
        renderStaff();
      } catch (err) {
        console.error(err);
        alert('Failed to remove staff. See console.');
      }
    }

    // Load report data
    async function loadReport() {
      try {
        const res = await fetch(reportApi);
        if (!res.ok) throw new Error('Failed to load report: ' + res.status);
        const report = await res.json();
        document.getElementById('salesTotal').innerText = report.sales ?? 0;
        document.getElementById('ordersCount').innerText = report.orders ?? 0;
        document.getElementById('reportTime').innerText = report.lastUpdated ? new Date(report.lastUpdated).toLocaleString() : '-';
      } catch (err) {
        console.warn('No report available or failed to load:', err);
        // keep defaults
      }
    }

    // Generate new report and save
    async function generateReport() {
      const newSales = Math.floor(10000 + Math.random() * 5000);
      const newOrders = Math.floor(300 + Math.random() * 50);
      const timestamp = new Date().toISOString();

      document.getElementById('salesTotal').innerText = newSales;
      document.getElementById('ordersCount').innerText = newOrders;
      document.getElementById('reportTime').innerText = new Date(timestamp).toLocaleString();

      try {
        // use PATCH if report exists, else POST to create
        const resGet = await fetch(reportApi);
        if (resGet.ok) {
          await fetch(reportApi, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sales: newSales, orders: newOrders, lastUpdated: timestamp })
          });
        } else {
          // report endpoint not present, create at /reports
          await fetch('http://localhost:3000/reports', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sales: newSales, orders: newOrders, lastUpdated: timestamp })
          });
        }

        const msg = 'Report updated successfully at ' + new Date().toLocaleTimeString();
        const reportMsg = document.getElementById('reportMsg');
        reportMsg.innerText = msg;
        setTimeout(() => (reportMsg.innerText = ''), 9000);
      } catch (err) {
        console.error('Failed to save report:', err);
        alert('Failed to save report. See console.');
      }
    }

    // init
    fetchStaff();
    loadReport();
  </script>
</body>
</html>
